# frozen_string_literal: true

default_platform(:ios)

platform :ios do
  private_lane :asc_api_key do
    app_store_connect_api_key(
      key_id: ENV.fetch("ASC_KEY_ID"),
      issuer_id: ENV.fetch("ASC_ISSUER_ID"),
      key_content: ENV.fetch("ASC_KEY_CONTENT"),
      is_key_content_base64: true
    )
  end

  private_lane :build_and_upload do |options|
    scheme = options.fetch(:scheme)
    configuration = options.fetch(:configuration)
    app_identifier = options.fetch(:app_identifier)
    changelog = options[:changelog] || ENV["CHANGELOG"]
    require_changelog = options[:require_changelog]

    if require_changelog && changelog.to_s.strip.empty?
      UI.user_error!("changelog is required")
    end

    build_app(
      project: "code.xcodeproj",
      scheme: scheme,
      configuration: configuration,
      clean: true,
      output_directory: "builds/#{scheme}",
      export_method: "app-store"
    )

    if options[:publish_testflight]
      upload_to_testflight(
        api_key: asc_api_key,
        app_identifier: app_identifier,
        skip_waiting_for_build_processing: true
      )
    end

    if options[:publish_app_store]
      release_notes = changelog.to_s.strip.empty? ? nil : { "en-US" => changelog }

      upload_to_app_store(
        api_key: asc_api_key,
        app_identifier: app_identifier,
        release_notes: release_notes,
        precheck_include_in_app_purchases: false,
        skip_metadata: true,
        skip_screenshots: true
      )
    end
  end

  desc "Build and upload TestFlight for test"
  lane :test do |options|
    build_and_upload(
      scheme: "test",
      configuration: "test",
      app_identifier: "com.codedorian.test",
      changelog: options[:changelog],
      publish_testflight: true
    )
  end

  desc "Build and upload TestFlight for localhost"
  lane :localhost do |options|
    build_and_upload(
      scheme: "localhost",
      configuration: "localhost",
      app_identifier: "com.codedorian.localhost",
      changelog: options[:changelog],
      publish_testflight: true
    )
  end

  desc "Build and upload TestFlight for development"
  lane :development do |options|
    build_and_upload(
      scheme: "development",
      configuration: "development",
      app_identifier: "com.codedorian.development",
      changelog: options[:changelog],
      publish_testflight: true
    )
  end

  desc "Build and upload TestFlight for staging"
  lane :staging do |options|
    build_and_upload(
      scheme: "staging",
      configuration: "staging",
      app_identifier: "com.codedorian.staging",
      changelog: options[:changelog],
      publish_testflight: true
    )
  end

  desc "Build and upload TestFlight for production"
  lane :production do |options|
    build_and_upload(
      scheme: "production",
      configuration: "production",
      app_identifier: "com.codedorian",
      changelog: options[:changelog],
      require_changelog: true,
      publish_testflight: false,
      publish_app_store: true
    )
  end
end
